steps:
- name: node:10.12.0
  entrypoint: 'yarn'
  args: ['install']
- name: 'docker/compose:1.22.0'
  args: ['up', '-d']
- name: 'docker/compose:1.22.0'
  args: ['run', 'wait']
- name: node:10.12.0
  entrypoint: 'yarn'
  args: ['test']
  env:
  - MYSQL_HOST=mysql
  - MYSQL_USER=root
  - MYSQL_PASSWORD=12345
  - MYSQL_DATABASE=test
  - NODE_ENV=test
  - JWT_SECRET=1234567890
  - JWT_AUDIENCE=Daily Testing
  - JWT_ISSUER=Daily API Testing
  secretEnv: ['SLACK_WEBHOOK']
- name: node:10.12.0
  entrypoint: 'yarn'
  args: ['build']
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/$REPO_NAME:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME', '.']
- name: gcr.io/cloud-builders/gcloud
  args:
  - kms
  - decrypt
  - --ciphertext-file=./helm/values/prod.yaml.enc
  - --plaintext-file=./helm/values/prod.yaml
  - --location=global
  - --keyring=daily-ci
  - --key=daily-gateway-ci
- name: 'gcr.io/$PROJECT_ID/helm'
  entrypoint: 'bash'
  args: ['-c', '([[ "$BRANCH_NAME" == "master" ]] && /builder/helm.bash upgrade daily-gateway ./helm/daily-gateway --namespace daily -f ./helm/values/prod.yaml --set-string image.tag=$SHORT_SHA,image.repository=gcr.io/$PROJECT_ID/$REPO_NAME -i) || ([[ "$BRANCH_NAME" != "master" ]] && echo "Skipping...")']
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-central1-f'
  - 'CLOUDSDK_CONTAINER_CLUSTER=prod'
  - 'GCLOUD_PROJECT=devkit-prod'

images: ['gcr.io/$PROJECT_ID/$REPO_NAME:$SHORT_SHA', 'gcr.io/$PROJECT_ID/$REPO_NAME:$BRANCH_NAME']

secrets:
- kmsKeyName: projects/daily-ops/locations/global/keyRings/daily-ci/cryptoKeys/daily-gateway-ci
  secretEnv:
    SLACK_WEBHOOK: "CiQArXlbO2qXCBF8dwrRRvJ6F70aB1pqM6Hue8EdVSUelEahi5wSdgBj45jnAgZ4QxxVmNz6pV1+1329FaQnQR0Ciu3CUsj7E3y1NdN9Pqe5XB0RgPhXwt8pV7bAzhezJVa62gDN0VPt3EM/3lpLKdGe297/pfEj2VbUcrgaTvcFTWcXMgIUBIHZ1SxdDOwUz+ZlQ0kCbXAI6gWnBr8="
